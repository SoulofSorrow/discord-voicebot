# Drone CI Setup für Discord VoiceBot

## Übersicht

Diese Drone CI Konfiguration baut automatisch Docker Images und pusht sie in die Gitea Docker Registry.

## Voraussetzungen

1. **Drone CI Server** muss mit deiner Gitea-Instanz verbunden sein
2. **Gitea Docker Registry** muss aktiviert sein
3. Repository muss in Drone aktiviert sein

## Umgebungsvariablen

Die folgenden Variablen müssen in Drone gesetzt werden:

### Secrets (in Drone Repository Settings)

```bash
# Gitea Registry Zugangsdaten
gitea_username: dein-gitea-username
gitea_token: dein-gitea-access-token

# Optional: Webhook für Benachrichtigungen
webhook_url: https://your-webhook-url.com/drone
```

### Repository-Variablen (in Drone Settings)

```bash
# Gitea Registry URL (z.B. gitea.example.com oder git.example.com:5000)
GITEA_REGISTRY=gitea.example.com
```

## Gitea Access Token erstellen

1. Gehe zu deiner Gitea-Instanz
2. Navigiere zu: **Einstellungen** → **Anwendungen** → **Access Tokens**
3. Erstelle einen neuen Token mit folgenden Berechtigungen:
   - `read:package`
   - `write:package`
4. Kopiere den Token und füge ihn als `gitea_token` Secret in Drone hinzu

## Pipeline-Struktur

Die Konfiguration enthält 3 Pipelines:

### 1. `build-and-push` (Haupt-Pipeline)
- Wird ausgelöst bei: Push auf main/master, Tags
- Baut Docker Image für linux/amd64
- Pusht mit Tags:
  - `latest`
  - `<commit-sha>` (erste 8 Zeichen)
  - `<git-tag>` (bei Tag-Builds)

### 2. `build-multi-arch` (Multi-Architektur)
- Wird ausgelöst bei: Version Tags (v*)
- Baut für linux/amd64 und linux/arm64
- Abhängig von Haupt-Pipeline

### 3. `development-build` (Entwicklungs-Builds)
- Wird ausgelöst bei: Push auf develop oder dev/* Branches
- Erstellt Images mit `dev-` Präfix

## Image Tags

Nach einem erfolgreichen Build sind folgende Images verfügbar:

```bash
# Bei Push auf main
${GITEA_REGISTRY}/${OWNER}/${REPO}:latest
${GITEA_REGISTRY}/${OWNER}/${REPO}:<commit-sha>

# Bei Git Tag v1.0.0
${GITEA_REGISTRY}/${OWNER}/${REPO}:v1.0.0
${GITEA_REGISTRY}/${OWNER}/${REPO}:latest
${GITEA_REGISTRY}/${OWNER}/${REPO}:<commit-sha>

# Bei Push auf develop
${GITEA_REGISTRY}/${OWNER}/${REPO}:dev-develop
${GITEA_REGISTRY}/${OWNER}/${REPO}:dev-<commit-sha>
```

## Image aus Gitea Registry ziehen

### 1. Docker Login

```bash
docker login ${GITEA_REGISTRY}
# Username: dein-gitea-username
# Password: dein-gitea-token
```

### 2. Image pullen

```bash
docker pull ${GITEA_REGISTRY}/${OWNER}/discord-voicebot:latest
```

### 3. Container starten

```bash
docker run -d \
  --name discord-voicebot \
  -v $(pwd)/data:/usr/src/app/data \
  -v $(pwd)/logs:/usr/src/app/logs \
  --env-file .env \
  ${GITEA_REGISTRY}/${OWNER}/discord-voicebot:latest
```

## Docker Compose mit Gitea Registry

Aktualisiere deine `docker-compose.yml`:

```yaml
version: '3.8'

services:
  discord-voicebot:
    image: ${GITEA_REGISTRY}/${OWNER}/discord-voicebot:latest
    container_name: discord-voicebot
    restart: unless-stopped
    volumes:
      - ./data:/usr/src/app/data
      - ./logs:/usr/src/app/logs
    env_file:
      - .env
    ports:
      - "3000:3000"
      - "9090:9090"
```

Setze die Umgebungsvariablen:

```bash
export GITEA_REGISTRY=gitea.example.com
export OWNER=dein-username
docker-compose pull
docker-compose up -d
```

## Manuelle Build und Push (lokal testen)

```bash
# Variablen setzen
export GITEA_REGISTRY=gitea.example.com
export OWNER=dein-username
export REPO=discord-voicebot

# Build
docker build -t ${GITEA_REGISTRY}/${OWNER}/${REPO}:test .

# Login
docker login ${GITEA_REGISTRY}

# Push
docker push ${GITEA_REGISTRY}/${OWNER}/${REPO}:test
```

## Troubleshooting

### Fehler: "authentication required"
- Prüfe ob Gitea Token korrekt gesetzt ist
- Prüfe Token-Berechtigungen in Gitea
- Stelle sicher, dass die Gitea Package Registry aktiviert ist

### Fehler: "registry not found"
- Prüfe `GITEA_REGISTRY` Variable
- Stelle sicher, dass die URL korrekt ist (ohne http:// oder https://)
- Für Registry mit Port: `gitea.example.com:5000`

### Pipeline wird nicht getriggert
- Aktiviere das Repository in Drone
- Prüfe die Webhook-Konfiguration in Gitea
- Prüfe Branch/Event Trigger in `.drone.yml`

### Build schlägt fehl
- Prüfe Drone Logs: `drone build logs <owner>/<repo> <build-number>`
- Stelle sicher, dass Dockerfile korrekt ist
- Prüfe Docker-Plugin Version

## Gitea Package Registry aktivieren

Falls die Registry noch nicht aktiv ist, in der Gitea `app.ini`:

```ini
[packages]
ENABLED = true
```

Danach Gitea neu starten.

## Nützliche Drone CLI Befehle

```bash
# Build manuell triggern
drone build create <owner>/<repo>

# Build Logs anzeigen
drone build logs <owner>/<repo> <build-number>

# Secrets setzen
drone secret add \
  --repository <owner>/<repo> \
  --name gitea_username \
  --data <username>

drone secret add \
  --repository <owner>/<repo> \
  --name gitea_token \
  --data <token>
```

## Weitere Anpassungen

### Cache für schnellere Builds

Füge in `.drone.yml` hinzu:

```yaml
- name: restore-cache
  image: meltwater/drone-cache
  settings:
    backend: "filesystem"
    restore: true
    cache_key: "{{ .Repo.Name }}"
    mount:
      - node_modules

- name: rebuild-cache
  image: meltwater/drone-cache
  settings:
    backend: "filesystem"
    rebuild: true
    cache_key: "{{ .Repo.Name }}"
    mount:
      - node_modules
```

### Auto-Deploy nach Build

```yaml
- name: deploy
  image: appleboy/drone-ssh
  settings:
    host:
      from_secret: deploy_host
    username:
      from_secret: deploy_user
    key:
      from_secret: deploy_key
    script:
      - cd /path/to/app
      - docker-compose pull
      - docker-compose up -d
  when:
    branch:
      - main
    event:
      - push
```

## Support

Bei Fragen oder Problemen:
- Drone CI Docs: https://docs.drone.io
- Gitea Package Registry: https://docs.gitea.io/en-us/packages/overview/
